<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>อัปโหลด Excel & แสดงข้อมูล</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>อัปโหลดไฟล์ Excel</h1>
<input type="file" id="excelFile" accept=".xlsx" />
<table border="1" id="tableData"></table>

<script>
  const table = document.getElementById('tableData');

  function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const offset = date_info.getTimezoneOffset() * 60000;
    const correctedDate = new Date(date_info.getTime() + offset);
    const yyyy = correctedDate.getFullYear();
    const mm = String(correctedDate.getMonth() + 1).padStart(2, '0');
    const dd = String(correctedDate.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  async function sendDataToServer(data) {
    try {
      const res = await fetch('http://localhost:3000/upload-json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orders: data }),
      });
      const json = await res.json();
      alert('ส่งข้อมูลสำเร็จ: ' + json.message);
    } catch (e) {
      alert('ส่งข้อมูลไม่สำเร็จ');
      console.error(e);
    }
  }

  document.getElementById('excelFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = evt => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

      const parsedData = jsonData.map(row => {
        let dateVal = row['date'];
        if (typeof dateVal === 'number') {
          dateVal = excelDateToJSDate(dateVal);
        }
        return {
          order_id: row['order_id'] || '',
          date: dateVal || '',
          platform: row['platform'] || '',
          item: row['item'] || '',
          qty: Number(row['qty']) || 0,
          price: Number(row['price']) || 0
        };
      });

      // แสดงข้อมูลในตาราง
      table.innerHTML = `<tr>
        <th>Order ID</th><th>Date</th><th>Platform</th><th>Item</th><th>Qty</th><th>Price</th>
      </tr>`;

      parsedData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.order_id}</td>
          <td>${row.date}</td>
          <td>${row.platform}</td>
          <td>${row.item}</td>
          <td>${row.qty}</td>
          <td>${row.price}</td>
        `;
        table.appendChild(tr);
      });

      // ส่งข้อมูลไป server
      sendDataToServer(parsedData);
    };
    reader.readAsArrayBuffer(file);
  });
</script>
</body>
</html>
