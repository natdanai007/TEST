<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Excel + ORDER_ID + ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå)</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    max-width: 1000px;
    margin: auto;
    padding: 20px;
    background: #fff5f5;
    color: #5c0a0a;
    position: relative;
  }
  h1, h2 {
    text-align: center;
    color: #8b0000;
    text-shadow: 1px 1px 2px #f8d7da;
  }
  label {
    font-weight: bold;
    margin-right: 10px;
    color: #7a0a0a;
  }
  .filters {
    margin-bottom: 20px;
    background: #ffe5e5;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #cc4444;
  }
  input[type="date"], select, input[type="file"] {
    margin-right: 20px;
    padding: 6px 10px;
    border: 1px solid #cc4444;
    border-radius: 4px;
    outline-color: #b30000;
    font-weight: 600;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: #fff0f0;
    box-shadow: 0 0 8px rgba(139, 0, 0, 0.1);
    border-radius: 6px;
    overflow: hidden;
  }
  th, td {
    border: 1px solid #cc4444;
    padding: 10px 12px;
    text-align: center;
    color: #5c0a0a;
  }
  th {
    background: #8b0000;
    color: #fff;
    font-weight: 700;
    text-transform: uppercase;
  }
  tbody tr:hover {
    background-color: #f9d6d6;
  }
  tfoot td {
    font-weight: bold;
    background: #f5bcbc;
    color: #5c0a0a;
  }
  /* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
  #printBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #8b0000;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 6px rgba(139, 0, 0, 0.5);
    z-index: 9999;
    transition: background-color 0.3s ease;
  }
  #printBtn:hover {
    background-color: #b30000;
  }
  /* Responsive */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    table, th, td {
      font-size: 14px;
    }
    input[type="date"], select, input[type="file"] {
      margin-bottom: 10px;
      width: 100%;
    }
  }
</style>
</head>
<body>

<button id="printBtn" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>

<h1>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏à‡∏¥‡∏ô ‡πÇ‡∏ñ‡∏á ‡∏Å‡∏±‡∏ß ÈáëÈìúÈîÖ - Dome Suki)</h1>

<div class="filters">
  <label for="excelFile">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx):</label>
  <input type="file" id="excelFile" accept=".xlsx" />
  <br><br>
  <label for="startDate">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
  <input type="date" id="startDate" />
  <label for="endDate">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
  <input type="date" id="endDate" />
  <label for="platformFilter">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°:</label>
  <select id="platformFilter">
    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="Grab">Grab</option>
    <option value="LINE MAN">LINE MAN</option>
    <option value="ShopeeFood">ShopeeFood</option>
  </select>
</div>

<h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á Order ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
<table id="salesTable">
  <thead>
    <tr>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>ORDER ID</th>
      <th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏¥‡πâ‡∏ô)</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
    </tr>
  </thead>
  <tbody>
    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
  </tbody>
</table>

<h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</h2>
<p id="grandTotal" style="font-weight:bold; color:#7a0a0a;"></p>
<div id="byPlatform" style="color:#7a0a0a;"></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  let mockData = [];

  const tableBody = document.querySelector('#salesTable tbody');
  const grandTotal = document.getElementById('grandTotal');
  const byPlatform = document.getElementById('byPlatform');
  const printBtn = document.getElementById('printBtn');

  function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const offset = date_info.getTimezoneOffset() * 60000;
    const correctedDate = new Date(date_info.getTime() + offset);
    const yyyy = correctedDate.getFullYear();
    const mm = String(correctedDate.getMonth() + 1).padStart(2, '0');
    const dd = String(correctedDate.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function filterAndRender() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const platform = document.getElementById('platformFilter').value;

    let total = 0;
    let platformMap = {};

    tableBody.innerHTML = '';

    const filtered = mockData.filter(row => {
      const dateOK = (!start || row.date >= start) && (!end || row.date <= end);
      const platformOK = (platform === 'all' || row.platform === platform);
      return dateOK && platformOK;
    });

    if(filtered.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7" style="color:#b30000;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>';
      grandTotal.textContent = '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ö‡∏≤‡∏ó';
      byPlatform.innerHTML = '';
      return;
    }

    filtered.forEach(row => {
      const totalPerRow = row.qty * row.price;
      total += totalPerRow;

      if (!platformMap[row.platform]) platformMap[row.platform] = 0;
      platformMap[row.platform] += totalPerRow;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${row.order_id}</td>
        <td>${row.platform}</td>
        <td>${row.item}</td>
        <td>${row.qty}</td>
        <td>${row.price.toLocaleString()}</td>
        <td>${totalPerRow.toLocaleString()}</td>
      `;
      tableBody.appendChild(tr);
    });

    grandTotal.textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

    let platformHTML = '<u>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°:</u>';
    platformHTML += '<ul>';
    for (let key in platformMap) {
      platformHTML += `<li>${key}: ${platformMap[key].toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>`;
    }
    platformHTML += '</ul>';
    byPlatform.innerHTML = platformHTML;
  }

  document.getElementById('excelFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});

      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];

      const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});

      mockData = jsonData.map(row => {
        let dateValue = row['date'];
        if (typeof dateValue === 'number') {
          dateValue = excelDateToJSDate(dateValue);
        } else if (typeof dateValue === 'string') {
          dateValue = dateValue.trim();
        } else {
          dateValue = '';
        }

        return {
          date: dateValue,
          order_id: row['order_id'] || '',
          platform: row['platform'] || '',
          item: row['item'] || '',
          qty: Number(row['qty']) || 0,
          price: Number(row['price']) || 0
        };
      });

      if (mockData.length > 0) {
        const dates = mockData.map(d => d.date).sort();
        document.getElementById('startDate').value = dates[0];
        document.getElementById('endDate').value = dates[dates.length -1];
      }

      filterAndRender();
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById('startDate').addEventListener('change', filterAndRender);
  document.getElementById('endDate').addEventListener('change', filterAndRender);
  document.getElementById('platformFilter').addEventListener('change', filterAndRender);

  printBtn.addEventListener('click', () => {
    window.print();
  });
</script>

</body>
</html>
