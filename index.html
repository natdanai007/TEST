<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  let mockData = [];

  const tableBody = document.querySelector('#salesTable tbody');
  const grandTotal = document.getElementById('grandTotal');
  const byPlatform = document.getElementById('byPlatform');
  const printBtn = document.getElementById('printBtn');

  function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const offset = date_info.getTimezoneOffset() * 60000;
    const correctedDate = new Date(date_info.getTime() + offset);
    const yyyy = correctedDate.getFullYear();
    const mm = String(correctedDate.getMonth() + 1).padStart(2, '0');
    const dd = String(correctedDate.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function filterAndRender() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const platform = document.getElementById('platformFilter').value;

    let total = 0;
    let platformMap = {};

    tableBody.innerHTML = '';

    const filtered = mockData.filter(row => {
      const dateOK = (!start || row.date >= start) && (!end || row.date <= end);
      const platformOK = (platform === 'all' || row.platform === platform);
      return dateOK && platformOK;
    });

    if(filtered.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7" style="color:#b30000;">ไม่มีข้อมูลตามเงื่อนไขที่เลือก</td></tr>';
      grandTotal.textContent = 'ราคารวมทั้งหมด: 0 บาท';
      byPlatform.innerHTML = '';
      return;
    }

    filtered.forEach(row => {
      const totalPerRow = row.qty * row.price;
      total += totalPerRow;

      if (!platformMap[row.platform]) platformMap[row.platform] = 0;
      platformMap[row.platform] += totalPerRow;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${row.order_id}</td>
        <td>${row.platform}</td>
        <td>${row.item}</td>
        <td>${row.qty}</td>
        <td>${row.price.toLocaleString()}</td>
        <td>${totalPerRow.toLocaleString()}</td>
      `;
      tableBody.appendChild(tr);
    });

    grandTotal.textContent = `ราคฟหกฟหกหฟกด: ${total.toLocaleString()} บาท`;

    let platformHTML = '<u>ราคารวมตามแพลตฟอร์ม:</u>';
    platformHTML += '<ul>';
    for (let key in platformMap) {
      platformHTML += `<li>${key}: ${platformMap[key].toLocaleString()} บาท</li>`;
    }
    platformHTML += '</ul>';
    byPlatform.innerHTML = platformHTML;
  }

  // ฟังก์ชันส่งข้อมูล JSON ไป backend (เปลี่ยน URL ให้ตรงกับ backend จริงของคุณ)
  async function sendDataToServer(data) {
    try {
      const res = await fetch('http://localhost:3000/upload-json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orders: data }),
      });
      const result = await res.json();
      alert(`ส่งข้อมูลไปเซิร์ฟเวอร์สำเร็จ: ${result.message}`);
    } catch (error) {
      alert('ส่งข้อมูลไปเซิร์ฟเวอร์ไม่สำเร็จ');
      console.error(error);
    }
  }

  document.getElementById('excelFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});

      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];

      const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});

      mockData = jsonData.map(row => {
        let dateValue = row['date'];
        if (typeof dateValue === 'number') {
          dateValue = excelDateToJSDate(dateValue);
        } else if (typeof dateValue === 'string') {
          dateValue = dateValue.trim();
        } else {
          dateValue = '';
        }

        return {
          date: dateValue,
          order_id: row['order_id'] || '',
          platform: row['platform'] || '',
          item: row['item'] || '',
          qty: Number(row['qty']) || 0,
          price: Number(row['price']) || 0
        };
      });

      if (mockData.length > 0) {
        const dates = mockData.map(d => d.date).sort();
        document.getElementById('startDate').value = dates[0];
        document.getElementById('endDate').value = dates[dates.length -1];
      }

      sendDataToServer(mockData); // ส่งข้อมูล JSON ไป backend
      filterAndRender();
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById('startDate').addEventListener('change', filterAndRender);
  document.getElementById('endDate').addEventListener('change', filterAndRender);
  document.getElementById('platformFilter').addEventListener('change', filterAndRender);

  printBtn.addEventListener('click', () => {
    window.print();
  });
</script>
